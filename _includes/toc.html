<script>
    document.addEventListener("DOMContentLoaded", function () {

        const toc = document.getElementById("toc");
        if (!toc) return;

        // Select headings to include in the TOC
        const headings = document.querySelectorAll(".post-content h2, .post-content h3");
        if (!headings.length) return;

        // Create and append the "Contents" title
        const title = document.createElement("h3");
        title.textContent = "Contents";
        toc.appendChild(title);

        // Build the TOC immediately
        headings.forEach(h => {
            const id = h.id || h.textContent.trim().toLowerCase().replace(/\s+/g, "-");
            h.id = id;

            const li = document.createElement("li");
            const a = document.createElement("a");

            a.href = `#${id}`;
            a.textContent = h.textContent; // raw $...$ for now

            li.appendChild(a);
            toc.appendChild(li);
        });

        // Track which headings are currently visible
        const headingMap = new Map();

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                headingMap.set(entry.target.id, entry.isIntersecting);
            });

            const visibleHeadings = Array.from(headingMap.entries())
                .filter(([_, isVisible]) => isVisible)
                .map(([id]) => id);

            let activeId;

            if (visibleHeadings.length > 0) {
                activeId = visibleHeadings[0];
            } else {
                const sorted = Array.from(headingMap.keys());
                for (let i = sorted.length - 1; i >= 0; i--) {
                    const el = document.getElementById(sorted[i]);
                    if (el.getBoundingClientRect().top < window.innerHeight * 0.2) {
                        activeId = sorted[i];
                        break;
                    }
                }
            }

            document.querySelectorAll(".toc a").forEach(link => {
                link.classList.toggle("active", link.getAttribute("href") === `#${activeId}`);
            });
        }, {
            root: null,
            rootMargin: "0px 0px -70% 0px",
            threshold: 0
        });

        headings.forEach(h => observer.observe(h));

        // Typeset TOC after MathJax has finished rendering the post
        if (window.MathJax?.startup?.promise) {
            MathJax.startup.promise.then(() => MathJax.typesetPromise([toc]));
        }

    });
</script>
